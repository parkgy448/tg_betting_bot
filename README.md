# 🎰 스포츠 베팅 텔레그램 봇 v6

텔레그램 채널에서 스포츠 경기 결과를 예측하는 베팅 이벤트 봇입니다.  
관리자가 경기를 등록하면 채널에 베팅 공지가 자동으로 올라가고, 유저들이 버튼을 눌러 참여합니다.  
경기 종료 후 결과를 입력하면 정답자 중 랜덤으로 당첨자가 선정되어 채널에 공지됩니다.

---

## 📋 목차

- [주요 기능](#-주요-기능)
- [채널 메시지 미리보기](#-채널-메시지-미리보기)
- [설치 방법](#-설치-방법)
- [초기 설정](#-초기-설정)
- [봇을 채널 관리자로 등록](#-봇을-채널-관리자로-등록)
- [명령어 전체 목록](#-명령어-전체-목록)
- [운영 흐름](#-운영-흐름)
- [파일 구조](#-파일-구조)
- [데이터 구조](#-데이터-구조-bot_datajson)
- [주의사항 및 트러블슈팅](#-주의사항--트러블슈팅)

---

## ✨ 주요 기능

| 기능 | 설명 |
|------|------|
| 📢 **베팅 공지 자동 게시** | `/newgame` 완료 시 채널에 공지 자동 업로드 |
| 📊 **실시간 막대그래프** | 베팅할 때마다 홈/무승부/원정 비율 그래프 업데이트 |
| 🏆 **다중 당첨자 추첨** | 경기 등록 시 당첨자 수 1~10명 자유 설정, 정답자 중 랜덤 추첨 후 채널 공지 |
| 🔄 **당첨자 재추첨** | 연락 불가 시 동일 정답자 중 설정된 인원수만큼 재추첨 |
| 🗑️ **경기 완전 삭제** | 베팅 공지·결과·당첨자 메시지 전부 일괄 삭제 |
| 🔐 **관리자 전용 잠금** | 지정 관리자만 운영 명령어 사용 가능, 무권한 접근 차단 |
| 👑 **관리자 동적 관리** | 봇 재시작 없이 `/addadmin` `/removeadmin` 으로 즉시 변경 |
| 💾 **데이터 자동 저장** | 봇 재시작 후에도 경기·베팅·통계 데이터 완전 복원 (JSON) |
| 🚀 **경기별 이벤트 상품** | 경기마다 다른 상품·금액 자유 설정 |
| 📈 **통계 대시보드** | 누적 경기 수·참가자·당첨자·최근 당첨 내역 조회 |
| 👥 **참가자 명단 조회** | 팀별 베팅자 명단 관리자 전용 조회 |
| 🚫 **중복 베팅 방지** | 경기당 1인 1베팅, 재베팅 시 팝업 알림 |

---

## 📱 채널 메시지 미리보기

### ① 베팅 진행 중

```
📢 고양 소노 vs 서울 삼성

⏰ 2026-02-19 19:00

🏠 홈 : 고양 소노
vs
✈️ 원정 : 서울 삼성
-----------------------------------
🔥결과 적중자 랜덤 3명 선발 🔥
🚀 포인트 100,000원 지급 !
✅ 배팅은 경기 시작 10분 전까지 가능 !
🧸경기 종료 후 당첨자 채널에 공지 !
🪙당첨자 문의 : @hellomypy
-----------------------------------
📊 현재 참가 현황  (총 40명)
🏠 홈 승  : ████████░░░░ 67% (27명)
⚖️ 무승부 : ██░░░░░░░░░░ 12% (5명)
✈️ 원정 승: ██░░░░░░░░░░ 20% (8명)

  [ 🏠 홈 승 ]  [ ⚖️ 무승부 ]  [ ✈️ 원정 승 ]
```

> 유저가 버튼을 누를 때마다 막대그래프 수치가 실시간으로 업데이트됩니다.  
> 선발 인원 수는 경기 등록 시 설정한 `max_winners` 값으로 표시됩니다.

### ② 베팅 마감 후

```
📢 고양 소노 vs 서울 삼성

⏰ 2026-02-19 19:00

🏠 홈 : 고양 소노
vs
✈️ 원정 : 서울 삼성
-----------------------------------
🛑 베팅이 마감되었습니다.
-----------------------------------
📊 최종 참가 현황  (총 40명)
🏠 홈 승  : ████████░░░░ 67% (27명)
⚖️ 무승부 : ██░░░░░░░░░░ 12% (5명)
✈️ 원정 승: ██░░░░░░░░░░ 20% (8명)
```

### ③ 결과 확정

```
🎉 경기 결과가 확정되었습니다.

(고양 소노) VS (서울 삼성)
-----------------------------------
경기 결과: 홈 승 (고양 소노) !!
```

### ④ 당첨자 발표 (3명 당첨 예시)

```
🏆 당첨자 발표 !
(고양 소노) VS (서울 삼성)
-----------------------------------
경기 결과: 홈 승 (고양 소노) !!
당첨자 : 3명
1. @user_a : 포인트 100,000원
2. @user_b : 포인트 100,000원
3. @user_c : 포인트 100,000원

당첨자 문의 : @hellomypy
```

### ⑤ 재추첨 발표 (3명 재추첨 예시)

```
🔄 당첨자 재추첨 결과
(고양 소노) VS (서울 삼성)
-----------------------------------
경기 결과: 홈 승 (고양 소노) !!
재추첨 당첨자 : 3명
1. @user_d : 포인트 100,000원
2. @user_e : 포인트 100,000원
3. @user_f : 포인트 100,000원

당첨자 문의 : @hellomypy
```

---

## 🚀 설치 방법

### 요구 사항

- **Python 3.10 이상** (3.11 권장 — 3.13은 라이브러리 호환 문제 있음)
- pip

### 1단계 — 저장소 클론

```bash
git clone https://github.com/your-username/sports-betting-bot.git
cd sports-betting-bot
```

### 2단계 — 가상환경 생성 (권장)

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS / Linux
python3 -m venv venv
source venv/bin/activate
```

> Python 버전을 3.11로 명시하려면:
> ```bash
> # Windows
> py -3.11 -m venv venv
>
> # macOS / Linux
> python3.11 -m venv venv
> ```

### 3단계 — 라이브러리 설치

```bash
pip install "python-telegram-bot==21.10"
```

### 4단계 — 설정 후 실행

```bash
python app.py
```

정상 실행 시 터미널에 아래와 같이 출력됩니다:

```
2026-02-19 19:00:00 - __main__ - INFO - ✅ 봇 시작!
```

---

## ⚙️ 초기 설정

`app.py` 상단의 설정 블록을 수정합니다.

```python
# ════════════════════════════════════════════════════
#  ★ 여기만 수정하세요 ★
# ════════════════════════════════════════════════════
BOT_TOKEN     = "여기에_봇_토큰_입력"     # @BotFather 에서 발급
CHANNEL_ID    = "@채널아이디"             # 예) @mychannel  또는  -100xxxxxxxxxx
ADMIN_CONTACT = "@문의아이디"             # 당첨자 문의용 텔레그램 아이디
PRIZE_TEXT    = "포인트 100,000원"        # 기본 상품 (경기 등록 시 개별 변경 가능)

ADMIN_IDS: set = {
    123456789,    # ← 본인 텔레그램 숫자 ID 입력
}
```

### 봇 토큰 발급 방법

1. 텔레그램에서 [@BotFather](https://t.me/BotFather) 검색 후 대화 시작
2. `/newbot` 입력
3. 봇 표시 이름 입력 (예: `소노 베팅봇`)
4. 봇 유저네임 입력 — 반드시 `bot` 으로 끝나야 함 (예: `sono_betting_bot`)
5. 발급된 토큰을 `BOT_TOKEN` 에 붙여넣기

### 관리자 ID 확인 방법

본인 텔레그램 숫자 ID를 모를 경우:

1. `ADMIN_IDS` 에 임시로 아무 숫자 입력 후 봇 실행
2. 봇에게 DM으로 `/myid` 입력
3. 표시된 숫자 ID를 `ADMIN_IDS` 에 추가 후 봇 재시작

또는 기존 관리자가 `/addadmin <숫자ID>` 명령어로 즉시 추가 가능

---

## 📡 봇을 채널 관리자로 등록

봇이 채널에 메시지를 게시하고 삭제하려면 **채널 관리자 권한**이 필요합니다.

1. 채널 페이지 → **관리자** → **관리자 추가**
2. 봇 유저네임 검색 후 선택
3. 아래 권한 활성화:
   - ✅ **메시지 게시**
   - ✅ **메시지 편집**
   - ✅ **메시지 삭제**
4. **저장** 클릭

> **CHANNEL_ID 형식**  
> 공개 채널: `@채널명` (예: `@mychannel`)  
> 비공개 채널: `-100` 으로 시작하는 숫자 ID (예: `-1001234567890`)  
> 숫자 ID는 [@userinfobot](https://t.me/userinfobot) 에서 확인 가능

---

## 📖 명령어 전체 목록

### 🌐 일반 사용자 (누구나)

| 명령어 | 설명 |
|--------|------|
| `/start` | 봇 시작 인사 및 안내 |
| `/help` | 사용법 안내 (관리자에게는 추가 명령어도 표시됨) |
| `/myid` | 내 텔레그램 숫자 ID 확인 (관리자 등록 시 필요) |
| `/stats` | 통계 대시보드 — 누적 경기·참가자·당첨자·최근 당첨 내역 |

---

### 🔐 관리자 전용

#### 경기 운영

| 명령어 | 설명 |
|--------|------|
| `/newgame` | 새 경기 등록 (대화형 입력 — 홈팀 → 원정팀 → 날짜 → 시간 → 상품 → **당첨자 수**) |
| `/games` | 등록된 전체 경기 목록 및 `game_id` 확인 |
| `/close <game_id>` | 베팅 수동 마감 (결과 입력 전 먼저 마감할 때 사용) |
| `/result <game_id> <결과>` | 결과 입력 + 당첨자 자동 추첨 + 채널 공지 |
| `/reroll <game_id>` | 기존 당첨자 취소 후 동일 정답자 중 재추첨 |
| `/delete <game_id>` | 경기 데이터 삭제 + 채널의 관련 메시지 전부 삭제 |
| `/cancel` | `/newgame` 입력 도중 취소 |

**`/result` 결과값:**

| 입력값 | 의미 |
|--------|------|
| `home` | 홈팀 승 |
| `draw` | 무승부 |
| `away` | 원정팀 승 |

예시: `/result 3 home`

---

#### 참가자 조회

| 명령어 | 설명 |
|--------|------|
| `/members <game_id>` | 해당 경기 전체 베팅 참가자 명단 |
| `/members <game_id> home` | 홈 승 베팅자만 조회 |
| `/members <game_id> draw` | 무승부 베팅자만 조회 |
| `/members <game_id> away` | 원정 승 베팅자만 조회 |

---

#### 관리자 관리

| 명령어 | 설명 |
|--------|------|
| `/adminlist` | 현재 등록된 관리자 목록 확인 |
| `/addadmin <user_id>` | 새 관리자 추가 (즉시 반영, 봇 재시작 불필요) |
| `/removeadmin <user_id>` | 관리자 제거 (본인 제거 불가 / 마지막 1명 제거 불가) |

---

## 🔄 운영 흐름

```
[ 경기 등록 ]
관리자 → /newgame
       → 홈팀 이름 입력       예) 고양 소노
       → 원정팀 이름 입력     예) 서울 삼성
       → 경기 날짜 입력       예) 2026-02-19
       → 경기 시간 입력       예) 19:00
       → 이벤트 상품 입력     예) 포인트 100,000원
       → 당첨자 수 입력       예) 3  (1 ~ 10명)
       → 채널에 베팅 공지 자동 게시 ✅

[ 베팅 참여 ]
유저 → 채널 공지의 버튼 클릭 (🏠홈승 / ⚖️무승부 / ✈️원정승)
     → 베팅 완료 팝업 알림 표시
     → 채널 공지의 막대그래프 실시간 업데이트

[ 베팅 마감 ]  ← 선택 사항 (result 입력 시 자동 마감됨)
관리자 → /close <game_id>
       → 채널 공지가 "🛑 베팅 마감" 형태로 자동 변경

[ 결과 발표 ]
관리자 → /result <game_id> home  (또는 draw / away)
       → 채널에 결과 확정 메시지 자동 게시
       → 정답자 중 설정된 인원수(max_winners)만큼 랜덤 추첨
         (정답자 수가 당첨자 수보다 적으면 전원 당첨)
       → 채널에 당첨자 발표 메시지 자동 게시 ✅

[ 재추첨 ]  ← 필요 시
관리자 → /reroll <game_id>
       → 동일 정답자 중 설정된 인원수만큼 재추첨
       → 채널에 재추첨 결과 자동 게시 ✅

[ 경기 삭제 ]  ← 필요 시
관리자 → /delete <game_id>
       → 채널의 모든 관련 메시지 일괄 삭제
       → 봇 내부 데이터도 삭제 ✅
```

---

## 📁 파일 구조

```
sports-betting-bot/
│
├── app.py            # 봇 전체 코드 (단일 파일)
├── bot_data.json     # 자동 생성 — 경기·베팅·통계·관리자 데이터
├── README.md         # 이 문서
│
└── venv/             # 가상환경 (.gitignore 추가 권장)
```

---

## 🗄️ 데이터 구조 (bot_data.json)

봇이 자동으로 생성하고 관리합니다. **직접 수정하지 마세요.**

```json
{
  "game_counter": 5,
  "admin_ids": [123456789, 987654321],
  "games": {
    "1": {
      "home": "고양 소노",
      "away": "서울 삼성",
      "match_time": "2026-02-19 19:00",
      "prize": "포인트 100,000원",
      "max_winners": 3,
      "bets": {
        "home": [[123456, "user_a"], [234567, "user_b"]],
        "draw": [[345678, "user_c"]],
        "away": []
      },
      "message_id": 1001,
      "extra_msg_ids": [1002, 1003],
      "closed": true,
      "result": "home"
    }
  },
  "stats": {
    "total_games": 5,
    "total_bettors": 210,
    "total_winners": 15,
    "winner_history": [
      {
        "game": "고양 소노 vs 서울 삼성",
        "result": "홈 승 (고양 소노)",
        "winner": "user_a",
        "prize": "포인트 100,000원"
      }
    ]
  }
}
```

| 필드 | 타입 | 설명 |
|------|------|------|
| `game_counter` | int | 경기 ID 자동 증가 카운터 |
| `admin_ids` | list | 관리자 텔레그램 ID 목록 |
| `max_winners` | int | 해당 경기 당첨자 수 (1~10, 미설정 시 1명으로 처리) |
| `message_id` | int | 채널의 베팅 공지 메시지 ID |
| `extra_msg_ids` | list | 결과·당첨자·재추첨 메시지 ID 목록 (`/delete` 시 전부 삭제) |
| `closed` | bool | 베팅 마감 여부 |
| `result` | string\|null | 경기 결과 (`home` / `draw` / `away` / `null`) |

> **이전 버전 호환:** `max_winners` 필드가 없는 기존 경기는 자동으로 1명으로 처리됩니다.

---

## ⚠️ 주의사항 & 트러블슈팅

### 채널에 메시지가 올라가지 않을 때

봇의 채널 관리자 권한을 확인하세요.  
필요 권한: **메시지 게시**, **메시지 편집**, **메시지 삭제**

---

### Python 버전 호환 문제

Python 3.13에서 `python-telegram-bot` 설치 오류가 발생할 수 있습니다.  
**Python 3.11 사용을 권장합니다.**

```bash
# 현재 버전 확인
python --version

# Python 3.11 가상환경 생성 (Windows)
py -3.11 -m venv venv

# Python 3.11 가상환경 생성 (macOS/Linux)
python3.11 -m venv venv
```

---

### `/delete` 시 일부 메시지만 삭제되는 경우

`extra_msg_ids` 는 **v5 이후 등록한 경기**부터 저장됩니다.  
이전 버전에서 결과 발표한 경기는 베팅 공지만 삭제되고, 결과·당첨자 메시지는 채널에서 수동 삭제가 필요합니다.

---

### 당첨자 수가 정답자 수보다 많을 때

설정한 `max_winners` 가 실제 정답자 수보다 많을 경우, 정답자 전원이 당첨 처리됩니다.  
예) 당첨자 5명 설정, 정답자 3명 → 3명 전원 당첨

---

### GitHub 업로드 전 토큰 보안 처리

`BOT_TOKEN` 을 코드에 직접 입력한 채로 GitHub에 올리면 토큰이 노출됩니다.  
`.env` 파일 또는 환경변수로 분리하는 것을 권장합니다.

**방법 1 — 환경변수**

```python
import os
BOT_TOKEN = os.environ.get("BOT_TOKEN", "")
```

```bash
# macOS / Linux
export BOT_TOKEN="여기에_토큰"
python app.py

# Windows (cmd)
set BOT_TOKEN=여기에_토큰
python app.py
```

**방법 2 — .env 파일**

```bash
pip install python-dotenv
```

`.env` 파일 생성:
```env
BOT_TOKEN=여기에_토큰
CHANNEL_ID=@채널아이디
ADMIN_CONTACT=@문의아이디
```

`app.py` 상단에 추가:
```python
from dotenv import load_dotenv
load_dotenv()
BOT_TOKEN = os.environ.get("BOT_TOKEN")
```

---

### 권장 .gitignore

```gitignore
# 가상환경
venv/
.venv/

# 봇 데이터 (베팅 내역·개인정보 포함)
bot_data.json

# 환경변수
.env

# Python 캐시
__pycache__/
*.pyc
*.pyo

# 에디터
.vscode/
.idea/
```

---

## 📄 라이선스

MIT License — 자유롭게 수정 및 배포 가능합니다.
